<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop</title>
    <link rel="stylesheet" href="productStyle.css">
    <script src="./products.js" type="text/javascript"></script>

    <script>
         function checkQuantityTextbox(theTextbox) {
    errs = isNonNegInt(theTextbox.value, true);
    if (errs.length == 0) errs = ['You want:'];
    if (theTextbox.value.trim() == '') errs = ['Quantity'];
    document.getElementById(theTextbox.name + '_label').innerHTML = errs.join(", ");
  }
    window.onload = function () {
        let params = (new URL(document.location)).searchParams; // get the query string which has the form data
        // form was submitted so check that quantities are valid then redirect to invoice if ok.
        if (params.has('purchase_submit')) {
          has_errors = false; // assume quantities are valid from the start
          total_qty = 0; // need to check if something was selected so we will look if the total > 0
          for (i = 0; i < products.length; i++) {
            if (params.has(`quantity${i}`)) {
              a_qty = params.get(`quantity${i}`);
              // make textboxes sticky in case of invalid data
              product_selection_form[`quantity${i}`].value = a_qty;
              total_qty += a_qty;
              if (!isNonNegInt(a_qty)) {
                has_errors = true; // oops, invalid quantity
                checkQuantityTextbox(product_selection_form[`quantity${i}`]); // show where the error is
              }
            }
          }
          // Now respond to errors or redirect to invoice if all is ok
          if (has_errors) {
            alert("Please enter only valid quantities!");
          } else if (total_qty == 0) { // no quantity selections, just give a general alert
            alert("Please select some quantities!");
          } else { // all good to go!
            window.location = `./invoice.html${document.location.search}`;
            window.stop;
          }
        }
      }
    </script>
</head>
<body>
    <div>
        <main>
            <form name="quantity_form" action="./invoice.html" method="POST">
                <script>
                    // for loop that generates product data
                    for (i = 0; i < products.length; i++)
                        document.write(`
                <section class="item">
                    <h2 name = "products${i}_name">${products[i].name}</td>
                    </h2> 
                    <p>$${products[i].price}</p>
                    <img src="${products[i].image}" id = "image">
                    <p>Quantity Available: ${products[i].quantity_available}</p>
                    <p><label for = "quantities${i}" id = "quantities${i}_label">Enter Quantity Desired:</label><p>
                   <p><input type = "text" id = "quantities${i}" name = "quantities${i}"></p>
                </section>
            `);
                </script>

    </div>
    <footer>
        </p><input type="submit" id="purchase_button" value="Click Here to Purchase!"></p>
    </footer>
    </form>
    </main>
</body>
</html>