<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tops - Sheldon's Closet</title>
    <link rel="stylesheet" href="productStyle.css">
    <script src="./products.js" type="text/javascript"></script>
</head>

<script>
   window.onload = function() {
    let params = new URLSearchParams(window.location.search);

    // Existing error handling
    let errorMessages = params.get('error');
    let errorProduct = params.get('errorProduct'); // The product ID that caused the error

    if (errorMessages && errorProduct) {
        errorMessages = JSON.parse(errorMessages);
        let alertMessage = '';

        for (let inputName in errorMessages) {
            if (errorMessages[inputName].includes("Only") && errorMessages[inputName].includes("left")) {
                let availableQuantity = errorMessages[inputName].match(/Only (\d+) left/)[1];
                
                // Find the specific textbox related to the errorProduct
                let textBox = document.querySelector(`[name="${inputName}"][data-product-id="${errorProduct}"]`);
                if (textBox) {
                    textBox.style.borderColor = "red";
                    textBox.value = availableQuantity;
                }
            }
            alertMessage += errorMessages[inputName] + '\n';
        }
        if (alertMessage) {
            alert(alertMessage);
        }
    }

    // New code for handling cart summary or errors from server
    let cartSummary = params.get('cartSummary');
    let serverErrors = params.get('errors');
    
    if (cartSummary) {
        cartSummary = JSON.parse(cartSummary);
        alert("Items in your cart:\n" + cartSummary);
    } else if (serverErrors) {
        try {
            serverErrors = JSON.parse(serverErrors); // Try to parse the JSON string into an array
            if (Array.isArray(serverErrors)) {
                alert("Errors:\n" + serverErrors.join("\n")); // Join the array elements
            } else {
                alert("Errors:\n" + JSON.stringify(serverErrors)); // Convert the object to a string
            }
        } catch (error) {
            console.error("Error parsing serverErrors:", error);
        }
    }
};
</script>

<body>
    <nav> 
        <ul> 
            <li><a href="index.html"><b>HOME</b></a></li>
            <li><a href="accessories_display.html"><b>ACCESSORIES</b></a></li>
            <li><a href="bottoms_display.html"><b>BOTTOMS</b></a></li>
        </ul>
    </nav>
    
    <header>
        <h1>Sheldon's Closet - Tops</h1>
    </header>

    <main class="products-container">
        <!-- Loop to dynamically generate product listings for 'tops' -->
        <script>
            for (var i = 0; i < products.tops.length; i++) {
                document.write(`
                    <form action="/add-to-cart-tops" method="post">
                        <section class="item">
                            <img src="${products.tops[i].image}" alt="${products.tops[i].name}">
                            <h2>${products.tops[i].name}</h2>
                            <p>$${products.tops[i].price.toFixed(2)}</p>
                            <p>Quantity Available: ${products.tops[i].quantity_available}</p>
                            <div class="quantity-container">
                                <label for="quantity${i}">Quantity Desired:</label>
                                <input type="number" id="quantity${i}" name="quantity_${products.tops[i].product_id}" min="1" placeholder="0">
                                <input type="hidden" name="product_id" value="${products.tops[i].product_id}">
                            </div>
                            <input type="submit" value="Add to Cart" class="add-cart">
                        </section>
                    </form>
                `);
            }
        </script>
    </main>
    
    <footer>
        <p>&copy; 2023 Sheldon's Closet</p>
    </footer>
</body>
</html>
